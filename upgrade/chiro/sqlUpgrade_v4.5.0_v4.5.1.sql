-- Modifications des données de la bdd

UPDATE `system` SET `value`='v4.5.1' WHERE `name`='chiro';

UPDATE `forms` SET `javascript` =  '$(document).ready(function() {\r\n\r\n  if (!$(\".mousehelper\").length) \r\n    $(\"body\").append(\'<div class=\"helper hide mousehelper\"></div>\');\r\n\r\n  if (!$(\".svgMenuSingle\").length)\r\n    $(\"body\").append(\'\\\r\n      <ul class=\"dropdown-menu svgMenuSingle\" role=\"menu\" style=\"display:none;position:absolute;\" >\\\r\n          <li id=\"title><span tabindex=\"-1\" style=\"margin-left:20px;margin-right:10px;font-weight:700\">Menu</span></li>\\\r\n          <li class=\"dropdown-divider\"></li>\\\r\n      </ul>\');\r\n  if (!$(\".svgMenuMulti\").length)\r\n    $(\"body\").append(\'\\\r\n      <ul class=\"dropdown-menu svgMenuMulti\" role=\"menu\" style=\"display:none;position:absolute;\" >\\\r\n          <li id=\"title><span tabindex=\"-1\" style=\"margin-left:20px;margin-right:10px;font-weight:700\">Menu</span></li>\\\r\n          <li class=\"dropdown-divider\"></li>\\\r\n      </ul>\');\r\n\r\n\r\n  $(\"#navchiro\").insertAfter(\".chiroEvolSym\");\r\n  $(\"#tabchiro\").insertAfter(\"#navchiro\");\r\n  $(\".chiroVArray\").appendTo(\"#traitement\");\r\n  $(\".chiroTArray\").appendTo(\"#techniques\");\r\n  $(\".chiroAutres\").appendTo(\"#techniques\");\r\n  $(\".chiroNotes\").appendTo(\"#notes\");\r\n  $(\".chiroCS.hide\").removeClass(\"hide\");\r\n\r\n  (function() {\r\n\r\n    $(\'[data-toggle=\"popover\"]\').popover({container: \"#svgparent\"});\r\n\r\n    function checkall($d) {\r\n      var setmatrix = false;\r\n      var m = $d.panzoom(\"getMatrix\");\r\n      for (var i = 0; i < 6; i++) m[i] = parseInt(m[i]);\r\n      var w = $d.width();\r\n      var h = $d.height();\r\n      var wp = $d.parent().width();\r\n      var hp = $d.parent().height();\r\n      var limits = [w*(m[0]+1)/2-200, wp+w*(m[0]-1)/2-200, h*(m[0]+1)/2-200, hp+h*(m[0]-1)/2-200];\r\n\r\n      if (m[4] < -limits[0]){\r\n        m[4] = -limits[0];\r\n        setmatrix = true;\r\n      }\r\n      else if (m[4] > limits[1]){\r\n        m[4] = limits[1];\r\n        setmatrix = true;\r\n      };\r\n      if (m[5] < -limits[2]){\r\n        m[5] = -limits[2];\r\n        setmatrix = true;\r\n      }\r\n      else if (m[5] > limits[3]){\r\n        m[5] = limits[3];\r\n        setmatrix = true;\r\n      }\r\n      if (setmatrix)\r\n        $d.panzoom(\"pan\",m[4],m[5]);\r\n    }\r\n\r\n    var clickTO;\r\n    var $panzoom = $(\'.panzoom\').panzoom({\r\n        cursor:\"default\",\r\n        minScale: 1,\r\n        maxScale: 4,\r\n        transition: $(window).width()>=1024,\r\n        $zoomIn: $(\".zoomIn\"),\r\n        $zoomOut: $(\".zoomOut\"),\r\n        onStart: function(){\r\n          clickTO=setTimeout(function(){\r\n            $(\"#skeleton\").css(\"cursor\",\"move\");\r\n            clickTO=undefined;\r\n          }, 100)\r\n        },\r\n        onEnd: function(){\r\n          checkall($(this));\r\n          $(\"#skeleton\").css(\"cursor\",\"default\");\r\n          if (clickTO)\r\n            clearTimeout(clickTO)\r\n        }\r\n    });\r\n    $panzoom.parent().on(\'mousewheel.focal\', function( e ) {\r\n      if (e.ctrlKey==1) {\r\n        var delta = e.delta || e.originalEvent.wheelDelta;\r\n        var zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;\r\n        e.preventDefault();\r\n        $panzoom.panzoom(\'zoom\', zoomOut, {\r\n          minScale: 1,\r\n          maxScale: 4,\r\n          animate:false,\r\n          focal: e\r\n        });\r\n      };\r\n    });\r\n  })();\r\n\r\n  function setChiroSelected(entry){\r\n    if (entry) {\r\n      var $entry = $(\"input[placeholder=\'\"+entry+\"\']\");\r\n      if (!$entry.length)\r\n        return;\r\n      var $svgOs = $(\".os[value=\'\"+entry+\"\']\");\r\n      var $svgArt = $(\".articulation[value=\'\"+entry+\"\']\");\r\n      var value = $entry.attr(\"value\");\r\n      if ($svgOs.length)\r\n        $svgOs.each(function(idx,el){\r\n          if (!value || value == \"\")\r\n            el.className.baseVal = el.className.baseVal.replace(\" selected\",\"\");\r\n          else if (el.className.baseVal.indexOf(\" selected\") < 0)\r\n            el.className.baseVal += \" selected\";\r\n        });\r\n      else if ($svgArt.length)\r\n        $svgArt.each(function(idx,el){\r\n          if (!value || value == \"\" && el.className.baseVal.indexOf(\" nonvisible\") < 0)\r\n            el.className.baseVal += \" nonvisible\";\r\n          else\r\n            el.className.baseVal = el.className.baseVal.replace(\" nonvisible\",\"\");\r\n        });\r\n    }\r\n    else\r\n    {\r\n      $(\"input[type=hidden]\").each(function(index, element){\r\n        var entry = $(element).attr(\"placeholder\");\r\n        if (!entry || entry == \"\")\r\n          return;\r\n        var $svgOs = $(\".os[value=\'\"+entry+\"\']\");\r\n        var $svgArt = $(\".articulation[value=\'\"+entry+\"\']\");\r\n        var value = $(element).attr(\"value\");\r\n        if ($svgOs.length)\r\n          $svgOs.each(function(idx,el){\r\n            if (!value || value == \"\")\r\n              el.className.baseVal = el.className.baseVal.replace(\" selected\",\"\");\r\n            else if (el.className.baseVal.indexOf(\" selected\") < 0)\r\n              el.className.baseVal += \" selected\";\r\n          });\r\n        else if ($svgArt.length)\r\n          $svgArt.each(function(idx,el){\r\n            if ((!value || value == \"\") && el.className.baseVal.indexOf(\" nonvisible\") < 0)\r\n              el.className.baseVal += \" nonvisible\";\r\n            else if (value && value != \"\")\r\n              el.className.baseVal = el.className.baseVal.replace(\" nonvisible\",\"\");\r\n          });\r\n      });\r\n    }\r\n  }\r\n  setChiroSelected();\r\n\r\n  function svgFit(animate){\r\n    var $s = $(\"#skeleton\");\r\n    $s.panzoom(\'setMatrix\', [1, 0, 0, 1, ($s.parent().width() - 20 - $s.width()) / 2, 10], {animate:animate});\r\n    $s.parent().height($s.height()+20);\r\n  };\r\n  svgFit(false);\r\n  \r\n  $(document).scroll(function(e){\r\n    if ($(\"#svgparent\").length)\r\n      $(\".tools\").css(\"top\", Math.min($(\"#svgparent\").height()-$(\".tools\").height()+20, Math.max(0, e.pageY+60-$(\"#svgparent\").offset().top)));\r\n  });\r\n\r\n  $(\"body\").on(\"touchstart\", \"#skeleton\", function(e){\r\n    if(e.touches.length>1)\r\n      e.stopPropagation();\r\n  });\r\n\r\n  $(\"body\").on(\"touchstart\", \"path,g,div,svg,form\", function(e){\r\n    if(e.touches.length > 1)\r\n      e.preventDefault();\r\n  });\r\n\r\n  $(\"body\").on(\"touchmove\", \"path,g,div,svg,form\", function(e){\r\n    if(e.touches.length > 1)\r\n      e.preventDefault();\r\n  });\r\n\r\n  $(\"body\").on(\"mousedown\", \".showAll\", function(){\r\n    $(\".os:not(.show),.articulation:not(.show)\").each(function(idx,el){el.className.baseVal+=\" show\"})\r\n  });\r\n  $(\"body\").on(\"mouseup\", \".showAll\", function(){\r\n    $(\".selectable,.os,.articulation\").each(function(idx,el){el.className.baseVal=el.className.baseVal.replace(\" show\", \"\")})\r\n  });\r\n\r\n  $(\"body\").on(\"click\", \".zoomFit\", function(){\r\n    svgFit(true);\r\n  });\r\n  $(window).on(\"resize\", function(){\r\n    svgFit(true);\r\n  });\r\n\r\n  $(\"body\").on(\"click\", \".menuSingle\", function (e) {\r\n    var $menu = $(\".svgMenuSingle\")\r\n      .show()\r\n      .css({left: Math.max(0, e.pageX-50), top: Math.max(0, e.pageY-50)})\r\n      .off(\'click\')\r\n      .on(\"mouseleave\", function(){\r\n        $(this).hide()\r\n        .children(\"li:nth-child(n+3)\").remove();\r\n      })\r\n      .on(\'click\', \'a\', function (e) {\r\n        e.stopImmediatePropagation();\r\n        var chk = $(this).children(\"input\").prop(\"checked\");\r\n        $(this).parent().parent().find(\"input\").prop(\"checked\", false);\r\n        $(this).children(\"input\").prop(\"checked\", !chk);\r\n        //on fixe la valeur de l\'entrée de formulaire\r\n        var $entry = $(\"input[placeholder=\'\"+$(this).attr(\'data-entry\')+\"\']\");\r\n        var value = $(this).attr(\'data-value\');\r\n        if (chk)\r\n          $entry.attr(\"value\", \"\");\r\n        else\r\n          $entry.attr(\"value\", value);\r\n        setChiroSelected($(this).attr(\'data-entry\'));\r\n      });\r\n    var title = $(this).attr(\"value\");\r\n    var items = $(this).attr(\"menu\").trim().split(\",\");\r\n    $menu.children().first().html(title);\r\n    $menu.children((\"li:gt(1)\")).remove();\r\n    for (var i=0; i< items.length; i++)\r\n      $menu.append(\'<li><a tabindex=\"-1\" style=\"text-decoration:none;color:#484848\" class=\"containerCheck\" data-entry=\"\'+title\r\n      + \'\" data-value=\"\' +items[i]+\r\n      \'\">\'+items[i]+\'<input type=\"radio\"\'+($(\"input[placeholder=\'\"+title+\"\']\").attr(\"value\") == items[i] ? \' checked\' : \'\')+\r\n      \'></input><span class=\"checkmarkRadio\"></span></a></li>\');\r\n    return false;\r\n  });\r\n\r\n  $(\"body\").on(\"click\", \".menuMulti\", function (e) {\r\n    var $menu = $(\".svgMenuMulti\")\r\n      .show()\r\n      .css({left: Math.max(0, e.pageX-50), top: Math.max(0, e.pageY-50)})\r\n      .off(\'click\')\r\n      .on(\"mouseleave\", function(){\r\n        $(this).hide()\r\n        .children(\"li:nth-child(n+3)\").remove();\r\n      })\r\n      .on(\'click\', \'a\', function (e) {\r\n        e.stopImmediatePropagation();\r\n        var chk = $(this).children(\"input\").attr(\"checked\");\r\n        if (chk)\r\n          $(this).children(\"input\").removeAttr(\"checked\");\r\n        else\r\n          $(this).children(\"input\").attr(\"checked\",\"\");\r\n        //on fixe la valeur de l\'entrée de formulaire\r\n        var $entry = $(\"input[placeholder=\'\"+$(this).attr(\'data-entry\')+\"\']\");\r\n        var value = $entry.attr(\"value\");\r\n        var newValue = $(this).attr(\'data-value\');\r\n        var idx;\r\n        if (value && (idx=value.trim().split(\",\").findIndex(function(v){return v==newValue})) >= 0)\r\n          $entry.attr(\"value\",value.trim().split(\",\").filter(function(v,i){return i!=idx}).join());\r\n        else if (value && value != \"\")\r\n          $entry.attr(\"value\", value + \",\" + newValue);\r\n        else\r\n          $entry.attr(\"value\", newValue);\r\n        setChiroSelected($(this).attr(\'data-entry\'));\r\n      });\r\n    var title = $(this).attr(\"value\");\r\n    var items = $(this).attr(\"menu\").trim().split(\",\");\r\n    console.log(items);\r\n    var value = $(\"input[placeholder=\'\"+title+\"\']\").attr(\"value\");\r\n    $menu.children().first().html(title);\r\n    $menu.children((\"li:gt(1)\")).remove();\r\n    for (var i=0; i< items.length; i++)\r\n      $menu.append(\'<li><a tabindex=\"-1\" style=\"text-decoration:none;color:#484848\" class=\"containerCheck\" data-entry=\"\'+title\r\n      + \'\" data-value=\"\' +items[i]+\r\n      \'\">\'+items[i]+\'<input type=\"checkbox\"\'+ ((value && value.trim().split(\",\").findIndex(function(v){return v==items[i]}) >= 0) ? \' checked\' : \'\')+\r\n      \'></input><span class=\"checkmarkCheck\"></span></a></li>\');\r\n    return false;\r\n  });\r\n\r\n  $(\"body\").on(\"click\", function(){\r\n    $(\".svgMenuSingle,.svgMenuMulti\").hide().children(\"li:nth-child(n+3)\").remove();\r\n  });\r\n\r\n  $(\"body\").on(\"click\", \".noMenu\", function(e){\r\n    e.stopImmediatePropagation();\r\n    var $entry = $(\"input[placeholder=\'\"+$(this).attr(\"value\")+\"\']\");\r\n    if ($entry.attr(\"value\") == \"true\")\r\n      $entry.attr(\"value\", \"\");\r\n    else\r\n      $entry.attr(\"value\", \"true\");\r\n    setChiroSelected($(this).attr(\"value\"));\r\n  });\r\n\r\n  $(\"body\").on(\"mouseenter\", \".os,.articulation\", function(e){\r\n      this.className.baseVal+=\" show\";\r\n      $(\"#mousehelper\").html($(this).attr(\"value\"))\r\n      .removeClass(\"hide\").css(\"left\", (e.pageX-100)+\"px\").css(\"top\", (e.pageY-50)+\"px\");\r\n  });\r\n\r\n  $(\"body\").on(\"mouseleave\", \".show\", function(){\r\n    if(this.className.baseVal) this.className.baseVal=this.className.baseVal.replace(\" show\", \"\");\r\n    $(\"#mousehelper:not(.hide)\").html(\"\").addClass(\"hide\");\r\n  });\r\n\r\n});';
