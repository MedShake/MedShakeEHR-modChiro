{#
 # This file is part of MedShakeEHR.
 #
 # Copyright (c) 2017
 # Bertrand Boutillier <b.boutillier@gmail.com>
 # http://www.medshake.net
 #
 # MedShakeEHR is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # any later version.
 #
 # MedShakeEHR is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with MedShakeEHR.  If not, see <http://www.gnu.org/licenses/>.
 #/

/##
 # Template > patient : dossier patient
 #
 # @author Bertrand Boutillier <b.boutillier@gmail.com>
 # @edited fr33z00 <https://github.com/fr33z00>
 #}

{% extends "page.html.twig" %}
{% import "macroForm.html.twig" as f %}
{% block title %}{{ page['patient']['administrativeDatas']['3']['value']|e }}
    {{ page['patient']['administrativeDatas']['2']['value']|e }} : dossier patient - MedShakeEHR{% endblock %}

{% block head %}
    <script>
      {# provoquer envoie asynchrone du patient dans le DICOM si config ok #}
      var dicomAutoSendPatient2Echo = {{ config.dicomAutoSendPatient2Echo }};
    </script>

    {{ parent() }}
    <script defer src="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/bower_components/tinymce/tinymce.min.js"></script>
    <script defer src="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/bower_components/tinymce/jquery.tinymce.min.js"></script>
    <script defer src="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/bower_components/panzoom/dist/jquery.panzoom.js"></script>
    <script defer src="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/bower_components/jquery-mousewheel/jquery.mousewheel.js"></script>

    {# JS général du dossier patient #}
    <script defer src="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/js/patient.js"></script>

    {# JS commun au formulaire de consultation du module #}
    <script defer src="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/js/module/common.js"></script>

    {# JS spécifiques des formulaires présents à l'affichage initial de la page #}
    {% for i in page.listeForms %}
      <script defer src="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/js/module/formsScripts/{{ i }}.js"></script>
    {% endfor %}

    <style>

       @media screen and (orientation:portrait) {
         #landscape{display: none;}
        }
       @media screen and (orientation:landscape) {
         #portrait{display: none;}
        }

        .chiroTArray input[type=checkbox] {box-shadow: none;} 
        .chiroTArray :nth-child(3) p{
          margin: 0 0 8px;
          font-size: 14px;
          font-weight: 700}
        .chiroTArray :nth-child(3) :nth-child(n+7) label{
          width: 40%;
          text-align: center;
          font-weight: 500 !important;
          font-size: 15px;
        }
        .chiroTArray  :nth-child(3) :nth-child(n+7) {
          height: 16px;
          margin: 0 0 5px;
        }
        .chiroTArray :nth-child(3) :nth-child(n+7) input {
          height: 16px;
          margin: -24px 0 0;
        }
        #newDoc{
          display: none;
        }
        .jumbotron{border-radius: 4px !important}
        .atcd {border: solid #ddd 1px;border-radius: 4px;padding-top: 10px;margin-left: 5px;margin-right:-10px !important;}
        @media (max-width:1024px) {
          .atcd {margin-left:16px !important;margin-right:16px !important; margin-bottom:10px}
          .col-md-9 {padding-left:30px !important; padding-right: 30px !important} 
        }

        path.show {fill:#f88 !important;}
        g.show:not(.special) path:nth-child(1){fill:#f88 !important;}
        g.special.show path:nth-child(2){fill:#f88 !important;}
        g.spe3.show path:nth-child(3){fill:#f88 !important;}
        g.spe17.show path:nth-child(17){fill:#f88 !important;}

	svg g,path,circle,rectangle{transition: fill .2s, fill-opacity .2s, stroke-opacity .2s;}

        path.selected {fill:#e44 !important;}
        g.selected:not(.special) path:nth-child(1){fill:#e44 !important;}
        g.special.selected path:nth-child(2){fill:#e44 !important;}
        g.spe3.selected path:nth-child(3){fill:#e44 !important;}
        g.spe17.selected path:nth-child(17){fill:#e44 !important;}

        .articulation {fill-opacity:.5;fill:#b82b2b;stroke-linecap:round;stroke-linejoin:round;stroke-width:.37795;stroke:#c82b25}
        .nonvisible{fill-opacity:0 !important; stroke-opacity:0 !important}
        .nonvisible:hover{fill-opacity:0.2 !important; stroke-opacity:0.3 !important}
        .nonvisible.show{fill-opacity:0.4 !important; stroke-opacity:1 !important}

        .btn {margin-bottom:5px}
        .btn-fullw {width:100%}
        .btn-fullw span{width:100%;text-align:center}
        .helper {position:absolute; border:solid 1px #ddd; border-radius:5px; text-weight:700;background-color:#fff;padding:4px;z-index:1000;}
        .hide {display: none}
        #svgMenuSingle input[type=checkbox]{margin:0 10px 0 0;line-height:16px;vertical-align:text-top}
        #svgMenuMulti input[type=checkbox]{margin:0 10px 0 0;line-height:16px;vertical-align:text-top}
        #svgMenuSingle a{cursor:default}
        #svgMenuMulti a{cursor:default}
        .tools {transition: top 0.1s}
        .jumbotron .btn-group:hover .dropdown-menu {
            display: block;
            margin-top: 0;
         }
    </style>

{% endblock %}

{% block body %}

    <div id="portrait" class="container" style="padding-top: 40px;">
      <div class="jumbotron" role="alert"><p>Placez votre écran en mode paysage !</p></div>
    </div>

    <div id="mousehelper" class="helper hide">
    </div>
    <ul id="svgMenuSingle" class="dropdown-menu" role="menu" style="display:none;position:absolute;" >
        <li id="title><span tabindex="-1" style="margin-left:20px;margin-right:10px;font-weight:700">Menu</span></li>
        <li class="divider"></li>
    </ul>
    <ul id="svgMenuMulti" class="dropdown-menu" role="menu" style="display:none;position:absolute;" >
        <li id="title><span tabindex="-1" style="margin-left:20px;margin-right:10px;font-weight:700">Menu</span></li>
        <li class="divider"></li>
    </ul>
    <div id="landscape">
     <div class="container-fluid">
        {% if page.patient.dossierType =="deleted" %}
        <div class="row alert alert-danger" role="alert">Ce dossier est marqué comme supprimé !</div>
        {% endif %}
        <div class="row" id="identitePatient" data-patientID="{{ page.patient.id }}">

            {% include('inc-ajax-patientAdminData.html.twig') %}

        </div>

<!--      <div class="col-md-6"style="padding-top: 58px;"> 
      </div> -->
      </div>

        <div class="row" style="margin-top : 20px;">
            <div  class="col-md-3 atcd">
              {# Formulaire dlatéral des ATCD #}
              <div id="latForm" class=" changeObserv">
                  {{ f.formbuilder(page.formData_chiroATCD , page.formName_chiroATCD , valFormLat ) }}
              </div>
              {# Liens familiaux #}
              {% if page.liensFamiliaux %}

              <div class="panel panel-default">
          			<div class="panel-heading gras">Liens familiaux <a class="btn btn-default btn-xs pull-right" role="button" href="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/patient/relations/{{ page.patient.id }}/" title="Édition des relations"><span class="glyphicon glyphicon-link" aria-hidden="true"></span></a>
                </div>

                <table class="table table-striped table-condensed table-hover small">
          				<thead>
          					<tr>
          						<th class="col-md-1"></th>
          						<th class="col-md-5">patient</th>
                      <th class="col-md-3">ddn</th>
          						<th class="col-md-3">relation</th>
          					</tr>
          				</thead>
          				<tbody>
                    {% for v in page.liensFamiliaux %}
                    <tr>
                      <td>
                        <a target="_blank" class="btn btn-default btn-xs" role="button" href="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/patient/{{ v.patientID }}/"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span></a>
                      </td>
                      <td class="gras">{{ v.nom }} {{v.prenom }}</td>
                      <td>{{ v.ddn }}</td>
                      <td>{{ v.typeRelation }}</td>
                    </tr>
                    {% endfor %}
          				</tbody>

          			</table>
          		</div>

              {% endif %}
            </div>

            {# colonne principale #}
            <div class="col-md-9" style="padding-left : 35px">

                {# historique du jour #}
                {% if page.patient.today %}{% include 'patientHistoriqueToday.html.twig' %}{% endif %}

                {# Synthèse patient #}
                {% include 'patientSynthese.html.twig' %}

                {# Div d'import de nouveau doc #}
                <div id="newDoc" class="row">{% include 'importDocForm.html.twig' %}</div>

                {# Div d'insertion de nouveau reglement #}
                <div id="newReglement" class="row"></div>

                {# Div d'insertion de nouveau courrier #}
                <div id="newCourrier" class="row"></div>

                {# Div d'insertion de nouvelle ordonance #}
                <div id="newOrdo" class="row"></div>

                {# Div d'insertion de nouvelle consultation #}
                <div id="nouvelleCs" class="row checkboxFixValue"></div>

                {# Div d'insertion de nouveau mail  #}
                <div id="newMail" class="row"></div>

                {# Historique complet #}
                {% if page.patient.historique %}{% include 'patientHistoriqueMedical.html.twig' %}{% endif %}
            </div>
          </div>

      </div>
    </div>

    {# modal changer nom consultation ou doc #}
    <div class="modal fade" id="alternatTitreModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
      aria-hidden="true">&times;</span></button>

            <h4 class="modal-title" id="exampleModalLabel">Compléter le titre</h4>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="titreActu" class="control-label">Complément :</label>
                <input type="text" class="form-control" id="titreActu">
                <input type="hidden" id="objetID" value="" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary" id="alternatTitreModalSubmit">Modifier</button>
           </div>
         </div>
       </div>
     </div>

     {# modal rapatrier mesures examen particulier #}
     <div class="modal fade" id="listeDicomStudiesModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
       <div class="modal-dialog" role="document">
         <div class="modal-content">
           <div class="modal-header">
             <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
       aria-hidden="true">&times;</span></button>

             <h4 class="modal-title">Choisir un examen</h4>
           </div>
           <div class="modal-body">
             <form>
               <div class="form-group">
                 <label for="titreActu" class="control-label">Liste des études DICOM trouvées :</label>
                 <select class="form-control" id="listeDicomStudies"></select>

               </div>
             </form>
           </div>
           <div class="modal-footer">
             <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
             <button type="button" class="btn btn-primary" id="listeDicomStudiesSubmit">Rapatrier</button>
            </div>
          </div>
        </div>
      </div>

      {# modal éditer infos adminsitratives du patient #}
      <div id="editAdmin" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title gras">Edition des informations administratives du patient</h4>
            </div>
            <div class="modal-body changeObserv">
              {{ f.formbuilder(page.formEditAdmin , 'baseNewPatient' , session) }}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary modalAdminClose" data-dismiss="modal">Fermer</button>
            </div>
          </div>
        </div>
      </div>

      {# modal changer la date d'une ligne d'historique #}
      <div id="modalCreationDate" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title gras">Modifier la date affichée d'un élément de l'historique</h4>
            </div>
            <div class="modal-body">
              <p>Cet élément a été enregistré en base le <span id="modalRegisterDateDisplay"></span></p>
              <p>Il est actuellement affiché en date du <span id="modalCreationDateDisplay"></span></p>
              <form id="formNewCreationDate" action="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/patient/actions/changeObjetCreationDate/{{ page.patient.id }}/" method="post">
                <input name="objetID" type="hidden" value="" />
                <div class="form-group">
                    <label for="datepickHistoValue">Modifier la date d'effet pour le</label>
                    <div class="input-group date  col-md-6" id="datepickHisto">
                        <input name="newCreationDate" type="text" class="form-control" />
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                    </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
              <button type="button" class="btn btn-primary modalCreationDateClose" data-dismiss="modal">Modifier</button>
            </div>
          </div>
        </div>
      </div>
{% endblock %}
