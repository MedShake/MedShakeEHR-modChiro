{#
 # This file is part of MedShakeEHR.
 #
 # Copyright (c) 2017
 # fr33z00 <https://github.com/fr33z00>
 # http://www.medshake.net
 #
 # MedShakeEHR is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # any later version.
 #
 # MedShakeEHR is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with MedShakeEHR.  If not, see <http://www.gnu.org/licenses/>.
 #/

/##
 # Template > patient : en-tête du dossier patient (données administratives)
 #
 # @author fr33z00 <https://github.com/fr33z00>
 #}

{% set detail = [] %}
{# genre #}
{% if page['patient']['administrativeDatas']['administrativeGenderCode']['value'] == 'F' %}
  {% set detail = detail|merge(['&#9792;']) %}
{% elseif page['patient']['administrativeDatas']['administrativeGenderCode']['value'] == 'M' %}
  {% set detail = detail|merge(['&#9794;']) %}
{% endif %}
{# age #}
{% set detail = detail|merge([page.patient.administrativeDatas.birthdate.value|e]) %}
{# birthdate #}
{% if page.patient.administrativeDatas.birthdate.age %}
  {% set detail = detail|merge([page.patient.administrativeDatas.birthdate.age|e]) %}
{% endif %}
{# tel #}
{% if page.patient.administrativeDatas.homePhone.value and page.patient.administrativeDatas.mobilePhone.value %}
  {% set detail = detail|merge([page.patient.administrativeDatas.mobilePhone.value|e ~ ' / ' ~ page.patient.administrativeDatas.homePhone.value|e]) %}
{% elseif page.patient.administrativeDatas.mobilePhone.value %}
  {% set detail = detail|merge([page.patient.administrativeDatas.mobilePhone.value|e]) %}
{% elseif page.patient.administrativeDatas.homePhone.value %}
  {% set detail = detail|merge([page.patient.administrativeDatas.homePhone.value|e]) %}
{% endif %}
{# adresse #}
{% set add = page.patient.administrativeDatas.streetNumber.value|e ~ ' ' ~ page.patient.administrativeDatas.street.value|e ~ ' ' ~
             page.patient.administrativeDatas.postalCodePerso.value|e ~ ' ' ~ page.patient.administrativeDatas.city.value|e %}
{% if (add|trim) != '' %}
  {% set detail = detail|merge([add]) %}
{% endif %}

<h1>{# firstname #}
    {{ page.patient.administrativeDatas.firstname.value|e }}
    {# lastname & birthname #}
    {% if page.patient.administrativeDatas.birthname.value and page.patient.administrativeDatas.lastname.value %}
  {{ page.patient.administrativeDatas.lastname.value|e }} (né{% if page.patient.administrativeDatas.administrativeGenderCode.value =='F' %}e{% endif %} {{ page.patient.administrativeDatas.birthname.value|e }})
    {# birthname only #}
    {% elseif page.patient.administrativeDatas.birthname.value %}
  {{ page.patient.administrativeDatas.birthname.value|e }}
    {# lastname only #}
    {% elseif page.patient.administrativeDatas.lastname.value %}
  {{ page.patient.administrativeDatas.lastname.value|e }}
    {% endif %}
    <small>
      {{ detail|join(' - ') }}
    </small>
</h1>

<div class="btn-group">
        {% if page.patient.administrativeDatas.notes.value %}
          <button id="voirNotesPatient" type="button" class="btn btn-light btn-sm" title="Voir les notes">
              <span class="fa fa-comment" aria-hidden="true"></span>
          </button>
        {% endif %}

        <button type="button" class="btn btn-light btn-sm" data-toggle="modal" data-target="#editAdmin" title="Édition des données administratives"><span class="fa fa-pencil-alt" aria-hidden="true"></span></button>

        {# email #}
        {% if page.patient.administrativeDatas.personalEmail.value %}
          <div class="btn-group">
            <button type="button" class="btn btn-light btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              {{ page.patient.administrativeDatas.personalEmail.value|e }} 
            </button>

            <ul class="dropdown-menu">
              <li><a class="dropdown-item newMail" href="#" data-formtocall="baseSendMail" data-mailtype="ns">Envoyer un mail</a></li>
              {% if config.smtpTracking %}
                <li><a class="dropdown-item" href="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/logs/historiqueMailSendToPatient/{{ page.patient.id }}/" >Historique des mails envoyés</a></li>
              {% endif %}
            </ul>
          </div>

        {% endif %}

        {% if page.correspondants %}
          {% for v in page.correspondants %}
            <a class="btn btn-light btn-sm" role="button" href="{{ config.protocol }}{{ config.host }}{{ config.urlHostSuffixe }}/pro/{{ v.pratID }}/" title="">{% if v.titre %}{{ v.titre }} {% endif %}{{ v.prenom }} {{ v.nom }}</a>
          {% endfor %}
        {% endif %}
</div>
<div id="notesPatient" class="card p-1" style="margin-top:20px;margin-bottom:10px;display: none;">
  {{ page.patient.administrativeDatas.notes.value|e|nl2br }}
</div>

